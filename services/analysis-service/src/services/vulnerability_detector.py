from typing import List, Dict
from models.analysis_models import Vulnerability, VulnerabilityType, SeverityLevel

class VulnerabilityDetector:
    """
    SCRUM-97: Vulnerability Classification System
    SCRUM-99: Severity Scoring System
    """
    
    def classify_vulnerabilities(self, raw_vulnerabilities: List[Dict]) -> List[Vulnerability]:
        """
        SCRUM-97: Classify and categorize vulnerabilities
        """
        classified = []
        
        for vuln in raw_vulnerabilities:
            try:
                # Map type to enum
                vuln_type = self._map_vulnerability_type(vuln.get("type", "unknown"))
                
                # Calculate severity (SCRUM-99)
                severity = self._calculate_severity(vuln)
                
                classified.append(Vulnerability(
                    type=vuln_type,
                    severity=severity,
                    line_number=vuln.get("line_number", 0),
                    code_snippet=vuln.get("code_snippet", ""),
                    description=vuln.get("description", ""),
                    recommendation=vuln.get("recommendation", ""),
                    confidence=vuln.get("confidence", 0.5)
                ))
            except Exception as e:
                print(f"⚠️ Failed to classify vulnerability: {e}")
                continue
        
        return classified
    
    def _map_vulnerability_type(self, type_str: str) -> VulnerabilityType:
        """
        SCRUM-97: Map string type to VulnerabilityType enum
        """
        type_mapping = {
            "sql_injection": VulnerabilityType.SQL_INJECTION,
            "cross_site_scripting": VulnerabilityType.XSS,
            "xss": VulnerabilityType.XSS,
            "authentication_bypass": VulnerabilityType.AUTH_BYPASS,
            "auth_bypass": VulnerabilityType.AUTH_BYPASS,
            "insecure_deserialization": VulnerabilityType.INSECURE_DESERIALIZATION,
            "sensitive_data_exposure": VulnerabilityType.SENSITIVE_DATA_EXPOSURE,
            "xml_external_entities": VulnerabilityType.XXE,
            "xxe": VulnerabilityType.XXE,
            "broken_access_control": VulnerabilityType.BROKEN_ACCESS_CONTROL,
            "security_misconfiguration": VulnerabilityType.SECURITY_MISCONFIGURATION,
            "injection": VulnerabilityType.INJECTION,
            "insecure_dependencies": VulnerabilityType.INSECURE_DEPENDENCIES,
        }
        
        return type_mapping.get(type_str.lower(), VulnerabilityType.UNKNOWN)
    
    def _calculate_severity(self, vuln: Dict) -> SeverityLevel:
        """
        SCRUM-99: Calculate severity score and map to level
        """
        # Use AI-provided severity if available
        severity_str = vuln.get("severity", "medium").lower()
        
        severity_mapping = {
            "critical": SeverityLevel.CRITICAL,
            "high": SeverityLevel.HIGH,
            "medium": SeverityLevel.MEDIUM,
            "low": SeverityLevel.LOW,
            "info": SeverityLevel.INFO,
        }
        
        base_severity = severity_mapping.get(severity_str, SeverityLevel.MEDIUM)
        
        # Adjust based on confidence
        confidence = vuln.get("confidence", 0.5)
        if confidence < 0.5 and base_severity == SeverityLevel.CRITICAL:
            return SeverityLevel.HIGH
        
        return base_severity
    
    def count_by_severity(self, vulnerabilities: List[Vulnerability]) -> Dict[str, int]:
        """
        SCRUM-99: Count vulnerabilities by severity level
        """
        counts = {
            "critical": 0,
            "high": 0,
            "medium": 0,
            "low": 0,
            "info": 0
        }
        
        for vuln in vulnerabilities:
            counts[vuln.severity.value] += 1
        
        return counts

vulnerability_detector = VulnerabilityDetector()